---
## Front matter
title: "Отчёт по лабораторной работе 11"
subtitle: "Настройка безопасного удалённого доступа по протоколу SSH"
author: "Метвалли Ахмед Фарг Набеех"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Цель работы

Освоение приёмов настройки SSH-сервера для ограничения удалённого доступа: запрета входа под пользователем root и разрешения подключения только определённым пользователям.

# Выполнение

## Запрет удалённого доступа по SSH для пользователя root

1. С клиента выполнена попытка подключения к серверу от имени пользователя root.  
   Сервер трижды запрашивал пароль, после чего выдал сообщение об ошибке.  
   Это означает, что вход под root запрещён на уровне конфигурации SSH.

   ![Ошибка подключения по SSH под root](Screenshot_1.png){ #fig:001 width=80% }

2. В конфигурационном файле /etc/ssh/sshd_config установлено значение параметра PermitRootLogin no.  
   После перезапуска службы sshd подключение под root остаётся невозможным, что подтверждает корректную работу настройки.

   ![Файл sshd_config с запретом root-входа](Screenshot_2.png){ #fig:002 width=80% }

## Ограничение списка пользователей для удалённого доступа по SSH

1. При попытке входа на сервер под пользователем ahmedfarg с клиента доступ был успешно получен, так как данный пользователь разрешён в текущей конфигурации SSH.

   ![Попытка входа под пользователем ahmedfarg](Screenshot_3.png){ #fig:003 width=80% }
   ![Успешное подключение ahmedfarg](Screenshot_4.png){ #fig:004 width=80% }

2. Для ограничения доступа только определённым пользователям в файл /etc/ssh/sshd_config добавлена строка AllowUsers vagrant.  
   После перезапуска службы sshd подключение под пользователем ahmedfarg стало невозможным.

   ![Файл sshd_config с ограничением пользователей](Screenshot_5.png){ #fig:005 width=80% }
   ![Ошибка подключения при AllowUsers vagrant](Screenshot_6.png){ #fig:006 width=80% }

3. После добавления обоих пользователей в список разрешённых AllowUsers vagrant ahmedfarg вход под ahmedfarg снова стал возможен.

   ![Файл sshd_config с двумя разрешёнными пользователями](Screenshot_7.png){ #fig:007 width=80% }
   ![Успешное подключение после разрешения пользователя](Screenshot_8.png){ #fig:008 width=80% }


## Настройка дополнительных портов для удалённого доступа по SSH

1. В конфигурационном файле /etc/ssh/sshd_config добавлены строки Port 22 и Port 2022.  
   Это позволяет использовать два порта для подключения по SSH, обеспечивая резервное соединение в случае ошибки конфигурации.

   ![Добавление второго порта в sshd_config](Screenshot_9.png){ #fig:009 width=80% }

2. После сохранения изменений и перезапуска службы sshd команда systemctl status -l sshd показала сообщение об ошибке.  
   Система выдала предупреждение об отказе в доступе к порту 2022 из-за ограничений SELinux.

   ![Ошибка доступа к порту 2022](Screenshot_10.png){ #fig:010 width=80% }

   Это означает, что SELinux блокировал использование нового порта для SSH-подключений.

3. Для устранения проблемы к порту 2022 была добавлена метка SELinux, разрешающая его использование для SSH:
   команда semanage port -a -t ssh_port_t -p tcp 2022.

4. В настройках межсетевого экрана открыт порт 2022 для протокола TCP с помощью команд firewall-cmd.  
   После этого служба sshd была перезапущена, и статус показал, что теперь сервер прослушивает оба порта.

   ![Открытие порта 2022 и успешный запуск sshd](Screenshot_11.png){ #fig:011 width=80% }

5. С клиента выполнено подключение к серверу по стандартному порту 22, а затем по дополнительному порту 2022.  
   В обоих случаях соединение установлено успешно, вход выполнен под пользователем ahmedfarg, после чего получен доступ root с помощью sudo -i.

   ![Подключение по стандартному и дополнительному портам](Screenshot_12.png){ #fig:012 width=80% }

## Настройка удалённого доступа по SSH по ключу

1. В конфигурационном файле /etc/ssh/sshd_config на сервере установлен параметр PubkeyAuthentication yes, разрешающий аутентификацию по ключам.

   ![Разрешение аутентификации по ключу в sshd_config](Screenshot_13.png){ #fig:013 width=80% }

2. На клиенте сгенерирована пара SSH-ключей. Закрытый ключ сохранён в ~/.ssh/id_rsa, открытый — в ~/.ssh/id_rsa.pub.  
   Открытый ключ скопирован на сервер с помощью команды ssh-copy-id.

3. После копирования ключа выполнено подключение к серверу. Аутентификация прошла без запроса пароля, что подтверждает корректную настройку SSH-доступа по ключу.

   ![Передача ключа и успешное подключение без пароля](Screenshot_14.png){ #fig:014 width=80% }

## Организация туннелей SSH и перенаправление TCP-портов

1. На клиенте выполнена проверка активных TCP-соединений — активных процессов, использующих TCP, не обнаружено.

2. Затем выполнено перенаправление порта 80 сервера на порт 8080 локальной машины с помощью SSH-туннеля.  
   После выполнения команды lsof | grep TCP отображается установленное SSH-соединение и локальное прослушивание порта 8080.

   ![Проверка TCP-соединений и организация туннеля SSH](Screenshot_15.png){ #fig:015 width=80% }

3. При обращении к адресу localhost:8080 в браузере открылась страница приветствия сервера, что подтверждает успешное создание SSH-туннеля.

   ![Отображение веб-страницы через туннель SSH](Screenshot_16.png){ #fig:016 width=80% }

## Запуск консольных приложений через SSH

1. С клиента получено имя узла сервера с помощью команды hostname, результат — server.ahmedfarg.net.

2. Выведен список файлов домашнего каталога пользователя на сервере, что подтвердило успешное выполнение удалённой команды через SSH.

   ![Проверка имени хоста и содержимого домашнего каталога](Screenshot_17.png){ #fig:017 width=80% }

3. Проверена работа почтовой программы в каталоге Maildir удалённого пользователя.  
   На экране отобразился список писем, хранящихся в почтовом каталоге.

   ![Просмотр почты пользователя через SSH](Screenshot_18.png){ #fig:018 width=80% }

## Запуск графических приложений через SSH (X11 Forwarding)

1. В конфигурационном файле /etc/ssh/sshd_config на сервере включён параметр X11Forwarding yes и перезапущен sshd.  

   ![Разрешение X11Forwarding в sshd_config](Screenshot_19.png){ #fig:019 width=80% }

2. При попытке запустить графическое приложение firefox через SSH с клиента выводится сообщение об ошибке — отсутствует переменная DISPLAY, что свидетельствует о невозможности запуска X11-сеанса в текущих настройках среды.

   ![Ошибка при попытке запуска графического приложения через SSH](Screenshot_20.png){ #fig:020 width=80% }

## Внесение изменений в настройки внутреннего окружения виртуальной машины

1. На сервере создан каталог /vagrant/provision/server/ssh с подкаталогом etc/ssh, в который был скопирован текущий файл конфигурации sshd_config.  
   Это позволяет хранить настройки SSH в структуре проекта Vagrant.

   ![Создание каталогов и копирование файла sshd_config](Screenshot_21.png){ #fig:021 width=80% }

2. В каталоге /vagrant/provision/server создан исполняемый файл ssh.sh, содержащий команды для автоматической настройки SSH.  
   Скрипт выполняет копирование конфигурационных файлов, настройку SELinux и межсетевого экрана, а также перезапускает службу sshd.

   ![Содержимое скрипта ssh.sh для автоматизации настройки SSH](Screenshot_22.png){ #fig:022 width=80% }

# Заключение

В ходе лабораторной работы были освоены методы администрирования SSH-сервера: настройка портов, ограничение доступа пользователей, создание туннелей, запуск консольных и графических приложений, а также автоматизация конфигурации с помощью скрипта.  
Результаты подтвердили корректность работы SSH при изменённых параметрах безопасности и сетевого взаимодействия.

# Контрольные вопросы

1. **Вы хотите запретить удалённый доступ по SSH на сервер пользователю root и разрешить доступ пользователю alice. Как это сделать?**  
   В файле /etc/ssh/sshd_config установить параметр PermitRootLogin no для запрета входа root и добавить строку AllowUsers alice для разрешения входа пользователю alice.  
   После внесения изменений необходимо перезапустить службу SSH.

2. **Как настроить удалённый доступ по SSH через несколько портов? Для чего это может потребоваться?**  
   В файле /etc/ssh/sshd_config указать несколько строк с параметром Port, например Port 22 и Port 2022.  
   Это обеспечивает резервный канал подключения в случае блокировки или ошибки на основном порту.

3. **Какие параметры используются для создания туннеля SSH, когда команда ssh устанавливает фоновое соединение и не ожидает какой-либо конкретной команды?**  
   Используются параметры fNL, где f переводит соединение в фоновый режим, N запрещает выполнение удалённых команд, а L задаёт локальное перенаправление портов.

4. **Как настроить локальную переадресацию с локального порта 5555 на порт 80 сервера server2.example.com?**  
   Необходимо использовать перенаправление с указанием локального и удалённого портов, чтобы обращения к адресу localhost:5555 перенаправлялись на порт 80 сервера server2.example.com.

5. **Как настроить SELinux, чтобы позволить SSH связываться с портом 2022?**  
   Добавить разрешение для SELinux, установив метку безопасности ssh_port_t для порта 2022, чтобы процесс SSH мог использовать этот порт.

6. **Как настроить межсетевой экран на сервере, чтобы разрешить входящие подключения по SSH через порт 2022?**  
   Добавить разрешающее правило в межсетевой экран firewalld для порта 2022 протокола TCP и сохранить изменения для постоянного применения.
