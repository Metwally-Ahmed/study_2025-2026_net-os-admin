---
## Front matter
title: "Отчёт по лабораторной работе 16"
subtitle: "Базовая защита от атак типа «brute force»"
author: "Метвалли Ахмед Фарг Набеех"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Цель работы

Получить навыки работы с программным средством Fail2ban для обеспечения базовой защиты от атак типа «brute force».

# Выполнение

## Установка и запуск Fail2ban

1. На сервер был установлен пакет Fail2ban с помощью пакетного менеджера.  
   После установки система добавила необходимые модули, включая серверную часть и средства интеграции с firewalld.

2. При первой попытке запуска была допущена ошибка в имени сервиса, после чего выполнен корректный запуск Fail2ban и добавление его в автозагрузку.  
   Система подтвердила создание символьной ссылки для автоматического запуска.

   ![Установка и запуск сервиса fail2ban](Screenshot_1.png){ #fig:001 width=80% }

## Просмотр журнала Fail2ban

3. Был выполнен просмотр журнала `/var/log/fail2ban.log`.  
   При запуске без прав root появилась ошибка доступа, после чего журнал был успешно открыт с использованием привилегий.  

   В журнале зафиксировано:  
   – запуск Fail2ban-сервера;  
   – запуск наблюдателя;  
   – подключение к базе данных;  
   – создание новой базы.

   ![Просмотр журнала /var/log/fail2ban.log](Screenshot_2.png){ #fig:002 width=80% }

## Создание локального файла конфигурации

4. Создан файл локальных настроек `/etc/fail2ban/jail.d/customisation.local`.

5. В файл добавлены базовые параметры и включена защита SSH с использованием стандартного порта и альтернативного порта 2022.

   ![Базовая локальная конфигурация Fail2ban (SSH-защита)](Screenshot_3.png){ #fig:003 width=80% }

## Перезапуск Fail2ban и проверка журналов (SSH)

6. Сервис Fail2ban был перезапущен для применения новой конфигурации.

7. В журнале зафиксировано создание и запуск тюрем для SSH, включая защиту от DDoS и интеграцию с SELinux.  
   Все компоненты успешно инициализированы и запущены.

   ![Создание и запуск SSH-тюрем Fail2ban](Screenshot_4.png){ #fig:004 width=80% }

## Включение защиты HTTP-сервисов

8. В локальной конфигурации были включены тюрьмы для защиты HTTP-сервисов Apache.

   ![Включение защиты HTTP-сервисов в customisation.local](Screenshot_5.png){ #fig:005 width=80% }

9. Сервис Fail2ban перезапущен.

10. Просмотр журнала показал создание и запуск всех HTTP-тюрем.  
    Fail2ban успешно подключился к логам веб-сервера и начал их мониторинг.

    ![Запуск HTTP-тюрем Fail2ban](Screenshot_6.png){ #fig:006 width=80% }

## Включение защиты почтовых сервисов

11. В локальной конфигурации были активированы тюрьмы для защиты почтовых сервисов Postfix и Dovecot.

    ![Добавление тюрем защиты почты](Screenshot_7.png){ #fig:007 width=80% }

12. Сервис Fail2ban вновь перезапущен.

13. В журнале зафиксировано создание и запуск всех почтовых тюрем.  
    Тюрьмы перешли в рабочий режим и начали обработку новых записей журналов.

    ![Запуск тюрем Fail2ban для почтовых сервисов](Screenshot_8.png){ #fig:008 width=80% }

## Просмотр статуса Fail2ban

1. На сервере был выполнен просмотр общего статуса Fail2ban.  
   Отобразилось количество активных тюрем (16) и их список.

2. Далее был просмотрен статус тюрьмы SSH (`sshd`).  
   На этом этапе ошибок входа и заблокированных адресов не было.

   ![Статус SSH-тюрьмы](Screenshot_9.png){ #fig:010 width=80% }

## Установка лимита ошибок и проверка блокировки

3. Максимальное количество ошибок входа для SSH было уменьшено до двух.  

4. С клиента выполнены входы по SSH с неверным паролем.

5. После этого вновь просмотрен статус SSH-защиты.  
   Fail2ban зафиксировал ошибки входа и заблокировал IP клиента.  
   Забаненный адрес появился в списке.

6. Затем IP-адрес клиента был разблокирован.  

7. Повторный просмотр статуса показал отсутствие блокировки.

   ![Разблокировка IP-адреса](Screenshot_10.png){ #fig:012 width=80% }

## Игнорирование IP-адреса клиента

8. В конфигурационный файл было добавлено исключение IP клиента, поместив его в список игнорируемых адресов (`ignoreip`).  
   Это предотвращает дальнейший бан данного источника.

   ![Добавление ignoreip в конфигурацию](Screenshot_11.png){ #fig:013 width=80% }

9. Сервис Fail2ban перезапущен.

10. В журнале событий появились сообщения о запуске тюрем и игнорировании указанного IP-адреса.

    ![Журнал Fail2ban после применения ignoreip](Screenshot_12.png){ #fig:014 width=80% }

11. Повторная попытка входа с клиента с неверным паролем не вызвала блокировки — статус тюрьмы подтверждает отсутствие забаненных адресов.

    ![Отсутствие блокировок после ignoreip](Screenshot_13.png){ #fig:015 width=80% }

## Создание provisioning-скрипта

1. На виртуальной машине **server** создан каталог для размещения конфигурации Fail2ban внутри структуры Vagrant:

   – выполнён переход в каталог `/vagrant/provision/server/`;  
   – создан подкаталог `protect/etc/fail2ban/jail.d`;  
   – файл локальной конфигурации был скопирован туда.

   ![Создание каталога и копирование конфигурации](Screenshot_14.png){ #fig:016 width=80% }

2. В каталоге `/vagrant/provision/server/` создан исполняемый файл `protect.sh`, содержащий автоматизацию установки Fail2ban, копирования конфигураций и запуска сервиса.

   ![Содержимое protect.sh](Screenshot_15.png){ #fig:017 width=80% }


# Заключение

Fail2ban был успешно установлен, настроен и протестирован для защиты SSH-, HTTP- и почтовых сервисов.  
Проведена проверка блокировки и разблокировки IP-адресов, добавление исключений и автоматизация конфигурации средствами Vagrant.

# Контрольные вопросы

1. **Поясните принцип работы Fail2ban.**  
   Fail2ban анализирует журналы сервисов, выявляет повторяющиеся ошибки аутентификации или подозрительные действия и временно блокирует IP-адрес источника через firewall.

2. **Настройки какого файла более приоритетны: `jail.conf` или `jail.local`?**  
   Файл `jail.local` имеет более высокий приоритет и его настройки переопределяют параметры из `jail.conf`.

3. **Как настроить оповещение администратора при срабатывании Fail2ban?**  
   Для этого в тюрьме необходимо выбрать действие (action), предусматривающее отправку email, например `action_mw` или `action_mwl`, и указать почтовый адрес администратора.

4. **Поясните построчно настройки по умолчанию в конфигурационном файле, относящиеся к веб-службе.**  
   – указание имени тюрьмы для веб-сервера;  
   – включение или выключение фильтра;  
   – выбор фильтра, анализирующего журнал веб-сервера;  
   – определение путей к логам веб-службы;  
   – параметр `maxretry` — число ошибок до блокировки;  
   – `findtime` — период, за который считаются ошибки;  
   – `bantime` — длительность блокировки.

5. **Поясните построчно настройки по умолчанию для почтовой службы.**  
   – включение тюрем для Postfix и Dovecot;  
   – выбор фильтров, анализирующих журналы почтовых сервисов;  
   – указание файлов логов Postfix и Dovecot;  
   – параметры попыток входа (`maxretry`), времени учёта (`findtime`) и длительности блокировки (`bantime`).

6. **Какие действия может выполнять Fail2ban при обнаружении атакующего IP-адреса? Где посмотреть список действий?**  
   Fail2ban может: блокировать IP через firewall, отправлять уведомления, выполнять сценарии, изменять маршруты, вносить записи в списки блокировки.  
   Описание действий приводится в каталоге `/etc/fail2ban/action.d/`.

7. **Как получить список действующих правил Fail2ban?**  
   Это выполняется через `fail2ban-client status`, где отображаются активные тюрьмы и их параметры.

8. **Как получить статистику заблокированных Fail2ban адресов?**  
   Для конкретной тюрьмы используется `fail2ban-client status <jail>`, где указан список заблокированных IP.

9. **Как разблокировать IP-адрес?**  
   Через команду `fail2ban-client set <jail> unbanip <ip>`, удаляющую адрес из списка заблокированных.
