---
## Front matter
title: "Отчёт по лабораторной работе 13"
subtitle: "Настройка NFS"
author: "Метвалли Ахмед Фарг Набеех"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Цель работы

Приобретение навыков настройки сервера NFS для удалённого доступа к ресурсам.

# Выполнение

## Настройка сервера NFSv4

### Установка и подготовка экспортируемого каталога

1. На сервере установлен пакет `nfs-utils`.

   ![Установка nfs-utils](Screenshot_1.png){ #fig:001 width=80% }

2. Создан каталог `/srv/nfs`, предназначенный для экспорта через NFS.

### Конфигурация доступа

1. В файле `/etc/exports` указан экспортируемый каталог с доступом только на чтение для всех клиентов сети:

   ![Содержимое /etc/exports](Screenshot_2.png){ #fig:002 width=80% }

2. Для каталога задан SELinux-контекст, позволяющий использовать его в качестве NFS-ресурса, и применены изменения.

3. Запущен сервис NFS и добавлен в автозагрузку. Добавлены необходимые правила в межсетевой экран.

   ![Запуск сервиса NFS и настройка firewall](Screenshot_3.png){ #fig:003  width=80% }

## Проверка работы с клиента

1. На клиентской машине установлено программное обеспечение `nfs-utils`.

2. Выполнена попытка просмотра экспортируемых ресурсов сервера. При включённом firewall команда выдала ошибку — клиент не мог получить ответ.

3. После остановки сервиса межсетевого экрана на сервере доступ к удалённому ресурсу стал возможен — клиент увидел экспортируемый каталог.

   ![Успешное подключение после отключения firewall](Screenshot_4.png){ #fig:004 width=80% }

## Корректная настройка firewall

1. Сервис межсетевого экрана снова запущен.

2. Определены службы, использующиеся при удалённом монтировании (`rpc-bind` и `mountd`). Они добавлены в правила межсетевого экрана.

   ![Добавление mountd и rpc-bind в firewall](Screenshot_5.png){ #fig:005 width=80% }

3. Клиент ещё раз проверил доступность ресурса. Список экспортируемых директорий был успешно получен, что подтверждает корректную работу NFS-сервера при настроенном firewall.

   ![Успешное подключение при корректных правилах firewall](Screenshot_6.png){ #fig:006 width=80% }

## Монтирование NFS на клиенте

1. На клиенте создан каталог для монтирования NFS-ресурса, затем выполнено подключение удалённого каталога `/srv/nfs` с сервера.

   ![Монтирование каталога /srv/nfs на клиенте](Screenshot_7.png){ #fig:007 width=80% }

2. После выполнения команды `mount` видно, что каталог `/mnt/nfs` смонтирован как сетевой ресурс типа `nfs4`.  
   Из вывода видно параметры подключения: используется NFS версии 4, обмен данными осуществляется по TCP, определены таймауты, а также IP-адрес клиента и сервера.

3. В конец файла `/etc/fstab` на клиенте добавлена строка автоматического монтирования:

   ![Запись в /etc/fstab для автоматического монтирования](Screenshot_8.png){ #fig:008 width=80% }

   **Пояснение синтаксиса записи:**

   | Поле                         | Описание                                                     |
   |------------------------------|--------------------------------------------------------------|
   | `server.user.net:/srv/nfs`   | удалённый ресурс на NFS-сервере                             |
   | `/mnt/nfs`                   | точка монтирования на клиенте                               |
   | `nfs`                        | используемая файловая система                               |
   | `_netdev`                    | указывает на необходимость ожидания сети перед монтированием |
   | `0 0`                        | отключение проверки dump и fsck для этого ресурса           |

4. Проверка автоматического монтирования с помощью systemd:

   ![Проверка удалённых файловых систем](Screenshot_9.png){ #fig:009 width=80% }

   Статус `active` подтверждает, что механизм автоматического подключения удалённых файловых систем работает.

5. После перезагрузки системы удалённый NFS-ресурс подключается автоматически, что подтверждено повторной проверкой.

   ![Каталог смонтирован после перезагрузки](Screenshot_10.png){ #fig:010 width=80% }

## Подключение каталогов к дереву NFS на сервере

1. На сервере создан каталог `/srv/nfs/www`, который будет частью экспортируемого NFS-дерева.

2. В каталог `/srv/nfs/www` подмонтирован каталог веб-сервера `/var/www`:

3. На клиенте в `/mnt/nfs` появился каталог `www`, что подтверждает корректное включение дополнительного каталога в NFS-дерево.

4. В файл `/etc/exports` на сервере добавлен экспорт нового каталога:

   ![/etc/exports с экспортом веб-каталога](Screenshot_11.png){ #fig:011 width=80% }

5. Все экспортируемые каталоги перечитаны командой `exportfs -r`.

6. В `/etc/fstab` добавлена запись bind-монтирования для автоматического подключения веб-каталога при загрузке сервера:

   ![Запись bind-монтирования в /etc/fstab](Screenshot_12.png){ #fig:012 width=80% }

7. После повторного экспорта клиент вновь проверяет содержимое `/mnt/nfs` и видит каталог `www`, что подтверждает успешное подключение.

   ![Проверка на клиенте](Screenshot_13.png){ #fig:013 width=80% }

## Подключение каталогов для работы пользователей

1. На сервере в домашнем каталоге пользователя создан каталог `common` с правами доступа только для владельца. Внутри создан файл `user@server.txt`.

   ![Создание каталога common и файла](Screenshot_14.png){ #fig:014 width=80% }

2. Создан каталог `/srv/nfs/home/user`, который будет экспортироваться по сети.

3. Каталог пользователя `common` подключён в дерево NFS с помощью bind-монтирования.

   ![Bind-монтирование каталога пользователя](Screenshot_15.png){ #fig:015 width=80% }

   Каталог имеет права доступа `700`, что означает:
   - **чтение, запись и исполнение доступны только владельцу;**
   - **доступ запрещён для группы и всех остальных пользователей.**

4. В файл `/etc/exports` добавлена запись, разрешающая доступ к каталогу пользователя из сети.

   ![/etc/exports с экспортом домашнего каталога пользователя](Screenshot_16.png){ #fig:016 width=80% }

   Запись обеспечивает экспорт каталога `/srv/nfs/home/user` в подсеть `192.168.0.0/16` с правами на чтение и запись.

5. В `/etc/fstab` добавлено bind-монтирование, чтобы каталог подключался автоматически при загрузке сервера.

   ![Запись bind-монтирования в /etc/fstab](Screenshot_17.png){ #fig:017 width=80% }

6. Каталоги экспортированы повторно.

7. На клиенте в каталоге `/mnt/nfs` появился каталог пользователя, содержащий файл, созданный на сервере.

8. На клиенте пользователь создал файл `user@client.txt` в каталоге `/mnt/nfs/home/user`.  
   Права доступа позволяют владельцу изменять содержимое каталога с клиента.

   ![Создание файла на клиенте](Screenshot_18.png){ #fig:018 width=80% }

9. На сервере в каталоге пользователя появились оба файла (`user@server.txt` и `user@client.txt`), что подтверждает синхронизацию через NFS.

   ![Файлы видны на сервере после изменений с клиента](Screenshot_19.png){ #fig:019 width=80% }

## Внесение изменений в настройки окружения виртуальных машин

1. В каталоге `/vagrant/provision/server/` создан каталог `nfs/etc`, в него скопированы конфигурационные файлы NFS.

2. Создан и заполнен исполняемый файл `nfs.sh`, предназначенный для автоматизации настроек NFS-сервера.

   ![Содержимое nfs.sh на сервере](Screenshot_20.png){ #fig:020 width=80% }

3. Аналогичный скрипт создан на клиенте.

   ![Содержимое скрипта клиента](Screenshot_21.png){ #fig:021 width=80% }

# Заключение

Сервер NFS был установлен, настроен и проверен. Экспортированы каталоги для общего доступа, произведено монтирование на клиенте, настроено автоматическое подключение через `/etc/fstab`, а также добавлены необходимые правила SELinux и брандмауэра. Дополнительно автоматизирован процесс настройки с помощью скриптов.

# Контрольные вопросы

1. **Как называется файл конфигурации, содержащий общие ресурсы NFS?**  
   Файл конфигурации экспорта ресурсов называется **`/etc/exports`**.  
   В нём указываются каталоги, доступ к которым предоставляется клиентам по сети.

2. **Какие порты должны быть открыты в брандмауэре, чтобы обеспечить полный доступ к серверу NFS?**  
   Для корректной работы NFS необходимо разрешить следующие службы и порты:
   - `nfs` — работа основного NFS-сервиса;
   - `rpc-bind` — порт 111 TCP/UDP (служба RPC);
   - `mountd` — порт демона монтирования.

3. **Какую опцию следует использовать в /etc/fstab, чтобы убедиться, что общие ресурсы NFS могут быть установлены автоматически при перезагрузке?**  
   Используется параметр **`_netdev`**.  
   Он указывает системе, что файловая система находится в сети, и её монтирование нужно выполнять только после установки сетевого соединения.
