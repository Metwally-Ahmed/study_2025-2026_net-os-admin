---
## Front matter
title: "Отчёт по лабораторной работе 8"
subtitle: "Настройка SMTP-сервера"
author: "Метвалли Ахмед Фарг Набеех"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Цель работы

Приобретение практических навыков по установке и конфигурированию SMTP-сервера.

# Выполнение

## Установка и первичная настройка почтового сервера Postfix

1. На виртуальной машине `server` выполнен вход под суперпользователем.  

2. Установлены необходимые пакеты для работы почтового сервера Postfix и клиента s-nail.  
   В процессе установки были загружены и установлены пакеты **postfix**, **postfix-lmdb** и **s-nail**.  

   ![Установка пакетов Postfix и s-nail](Screenshot_1.png){ #fig:001 width=80% }

3. Настроен межсетевой экран. Разрешён протокол **SMTP** как временно, так и на постоянной основе.  
   После выполнения команды **firewall-cmd --list-services** служба `smtp` появилась в списке разрешённых.  

4. Выполнено восстановление контекста безопасности в **SELinux** для каталога `/etc`.  

5. Служба Postfix добавлена в автозагрузку и запущена.  

   ![Запуск службы Postfix](Screenshot_1.png){ #fig:002 width=80% }

## Изменение параметров Postfix с помощью postconf

1. Для просмотра текущих настроек Postfix использована команда **postconf**, которая вывела полный список параметров.  

   ![Просмотр параметров Postfix](Screenshot_2.png){ #fig:003 width=80% }

2. Проверено значение параметра **myorigin**, по умолчанию равного `$myhostname`.  

3. Проверено значение параметра **mydomain**, установленного как `ahmedfarg.net`.  

4. Изменено значение параметра **myorigin** на `$mydomain`.  
   После проверки параметр успешно принял новое значение.  

   ![Изменение параметров myorigin и mydomain](Screenshot_3.png){ #fig:004 width=80% }

5. Выполнена проверка корректности конфигурации Postfix и перезагрузка службы.  

6. Просмотрены параметры, значения которых отличаются от настроек по умолчанию.  

   ![Результат команды postconf -n](Screenshot_4.png){ #fig:005 width=80% }

7. Задано постоянное значение домена `ahmedfarg.net` и отключён протокол IPv6, оставлен только IPv4.  
   После проверки конфигурации служба Postfix была перезагружена.  

   ![Отключение IPv6 и перезагрузка Postfix](Screenshot_5.png){ #fig:006 width=80% }

## Проверка работы Postfix

1. На сервере под учётной записью пользователя было отправлено тестовое письмо самому себе с помощью утилиты **mail**.  
   Сообщение успешно доставлено, что подтверждается записями в журнале `/var/log/maillog`.  
   В логе указано, что письмо от пользователя `ahmedfarg` было принято службой `postfix/pickup`, обработано `postfix/cleanup`, поставлено в очередь и доставлено локально.  
   Строка `status=sent (delivered to mailbox)` подтверждает успешную доставку письма.  

   ![Лог успешной доставки письма на сервере](Screenshot_6.png){ #fig:007 width=80% }

2. В каталоге `/var/spool/mail` появился файл пользователя `ahmedfarg`, содержащий полученное письмо.  
   Содержимое письма подтверждает корректную работу сервера: в нём указаны поля **From**, **To**, **Subject** и идентификатор сообщения.  

   ![Проверка содержимого почтового ящика пользователя](Screenshot_7.png){ #fig:008 width=80% }

3. На виртуальной машине `client` выполнена установка необходимых пакетов **postfix** и **s-nail**.  
   После установки была отключена поддержка IPv6, оставлен только IPv4, и запущена служба Postfix.  

   ![Настройка и запуск Postfix на клиенте](Screenshot_8.png){ #fig:009 width=80% }

4. На клиенте было отправлено второе тестовое письмо пользователю на сервере.  
   На сервере в журнале `/var/log/maillog` зафиксировано успешное подключение клиента `client.ahmedfarg.net` и последующая доставка сообщения.  
   Строки журнала показывают установку соединения (`connect from client.ahmedfarg.net`), передачу письма и подтверждение его доставки (`status=sent (delivered to mailbox)`).  

   ![Передача письма с клиента на сервер](Screenshot_10.png){ #fig:010 width=80% }

5. На сервере были просмотрены параметры сетевых интерфейсов и сетей в конфигурации Postfix.  
   Параметр **inet_interfaces** изначально был установлен в значение `localhost`.  
   Далее он был изменён на `all`, чтобы разрешить приём почты с других машин сети.  
   Параметр **mynetworks** был дополнен адресами `127.0.0.0/8` и `192.168.0.0/16`, что разрешило пересылку почты между узлами внутренней сети.  
   После этого Postfix был перезапущен и конфигурация перечитана.  

   ![Настройка сетевых интерфейсов и разрешённых сетей](Screenshot_9.png){ #fig:011 width=80% }

6. После внесённых изменений повторная отправка письма с клиента завершилась успешно.  
   В журнале сервера вновь зафиксирована доставка письма с клиента `192.168.1.30`, подтверждённая статусом `delivered to mailbox`.  
   Это свидетельствует о корректной работе связки **Postfix server + client**.

## Конфигурация Postfix для домена

1. На клиенте было отправлено письмо на доменный адрес пользователя.  
   Первые попытки отправки завершились неудачно: сервер отклонил соединение с ошибкой  
   `Connection refused` и `Temporary lookup failure`.  
   Проверка очереди сообщений показала наличие двух писем со статусами ожидания доставки.  

   ![Очередь сообщений на клиенте и ошибки доставки](Screenshot_11.png){ #fig:012 width=80% }

2. В журнале `/var/log/maillog` сервера зафиксированы ошибки обратной маршрутизации писем.  
   Сообщение от клиента было воспринято как замкнутая петля (`loops back to myself`) и отклонено.  
   Это указывало на отсутствие корректных DNS-записей для почтового домена.  

   ![Ошибки обратной маршрутизации в логе сервера](Screenshot_12.png){ #fig:013 width=80% }

3. Для устранения ошибки в файле прямой DNS-зоны `ahmedfarg.net` была добавлена MX-запись,  
   указывающая на почтовый сервер `mail.ahmedfarg.net`, а также A-записи для всех основных узлов домена.  
   Это позволило корректно разрешать имя почтового сервера.  

   ![Файл прямой зоны ahmedfarg.net с MX-записью](Screenshot_13.png){ #fig:014 width=80% }

4. В файле обратной DNS-зоны `192.168.1` были прописаны PTR-записи для всех хостов,  
   включая почтовый сервер `mail.ahmedfarg.net`.  
   Теперь доменные имена корректно резолвятся как в прямом, так и в обратном направлении.  

   ![Файл обратной зоны 192.168.1 с PTR-записями](Screenshot_14.png){ #fig:015 width=80% }

5. В конфигурации Postfix параметр **mydestination** был обновлён,  
   чтобы сервер принимал почту для собственного домена `ahmedfarg.net` и связанных поддоменов.  
   После внесения изменений служба была перезагружена, а контексты безопасности SELinux восстановлены.  

6. DNS-служба **named** была перезапущена для применения новых записей.  

7. После обновления DNS-зон и перезапуска служб письма из очереди были отправлены повторно.  
   Новые сообщения с клиента на сервер доставлены успешно.  
   В журнале `/var/log/maillog` сервера отображается корректное подключение клиента `192.168.1.30`  
   и успешная доставка письма (`status=sent (delivered to mailbox)`).  

   ![Успешная доставка письма с клиента на сервер](Screenshot_15.png){ #fig:016 width=80% }

8. Проверка содержимого почтового ящика показала наличие доставленного письма `test2`.  
   В его заголовках указано корректное прохождение через сервер `mail.ahmedfarg.net`,  
   что подтверждает правильную работу доменной почтовой маршрутизации.  

   ![Просмотр содержимого доставленного письма test2](Screenshot_16.png){ #fig:017 width=80% }

# Заключение

Почтовый сервер **Postfix** был установлен, сконфигурирован и успешно протестирован как на локальной машине, так и в сетевой среде.  
Были произведены настройки параметров домена, сетевых интерфейсов и разрешённых сетей.  
Созданы MX-записи в прямой и обратной DNS-зонах, обеспечившие корректную маршрутизацию сообщений внутри домена **ahmedfarg.net**.  
Тестовые письма, отправленные с сервера и клиента, были доставлены успешно, что подтверждает правильную работу почтовой инфраструктуры.

# Контрольные вопросы

1. **В каком каталоге и в каком файле следует смотреть конфигурацию Postfix?**  
   Основная конфигурация Postfix находится в каталоге **/etc/postfix**,  
   главный конфигурационный файл — **/etc/postfix/main.cf**.  
   Дополнительно используется файл **/etc/postfix/master.cf** для настройки работы демонов и сервисов.

2. **Каким образом можно проверить корректность синтаксиса в конфигурационном файле Postfix?**  
   Проверка выполняется командой:  
   **postfix check**  
   Она анализирует конфигурационные файлы и сообщает об ошибках в синтаксисе и структуре настроек.

3. **В каких параметрах конфигурации Postfix требуется внести изменения для настройки возможности отправки писем не на локальный хост, а на доменные адреса?**  
   Для этого необходимо настроить следующие параметры:  
   - **myorigin** — определяет домен исходящих сообщений;  
   - **mydomain** — задаёт имя почтового домена;  
   - **mydestination** — определяет список доменов, для которых сервер принимает почту;  
   - **relayhost** (опционально) — указывает внешний почтовый сервер для пересылки сообщений.  
   Также важно добавить корректную **MX-запись** в DNS-зоне домена.

4. **Примеры работы с утилитой mail:**  
   - Отправка письма:  
     `echo "Текст письма" | mail -s "Тема" user@domain.net`  
   - Просмотр списка писем:  
     `mail`  
   - Чтение конкретного письма:  
     `номер_письма`  
   - Удаление письма:  
     `d номер_письма`  
   - Выход из программы:  
     `q`

5. **Примеры работы с утилитой postqueue:**  
   - Просмотр очереди сообщений:  
     `postqueue -p`  
   - Определение количества писем в очереди:  
     `postqueue -p | grep -c "^[A-F0-9]"`  
   - Повторная отправка всех сообщений:  
     `postqueue -f`  
   - Удаление всех писем из очереди:  
     `postsuper -d ALL`  
   - Удаление конкретного письма по ID:  
     `postsuper -d <ID_письма>`
